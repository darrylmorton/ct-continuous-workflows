name: Smoke test - composite actions

on:
  workflow_dispatch: {}

jobs:
  smoke:
    name: Smoke test composite actions
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Resolve repo root (get-repo-root)
        id: get_repo
        uses: ./.github/actions/get-repo-root
        with:
          action-path-required: 'true'

      - name: Show resolved repo root
        shell: bash
        run: |
          echo "get-repo-root output: '${{ steps.get_repo.outputs.repo-path }}'"
          if [ -n "${{ steps.get_repo.outputs.repo-path }}" ]; then
            echo "Listing repo root contents:"
            ls -la "${{ steps.get_repo.outputs.repo-path }}" | sed -n '1,40p'
          else
            echo "Warning: repo-path output is empty"
          fi

      - name: Setup Python & Poetry (python-poetry-setup)
        id: setup_poetry
        uses: ./.github/actions/python-poetry-setup
        with:
          python-version: '3.11'
          poetry-version: '1.4.2'
          lockfile-path: '**/poetry.lock'
          action-path-required: 'true'
          repo-path: ${{ steps.get_repo.outputs.repo-path }}

      - name: Verify Poetry and Python
        shell: bash
        run: |
          echo "Python version: $(python --version)"
          echo "Poetry version: $(poetry --version 2>/dev/null || echo 'poetry not found')"
          # show basic poetry environment info if available
          poetry env info 2>/dev/null || true

      - name: Verify python-poetry-setup output
        shell: bash
        run: |
          echo "python-poetry-setup repo-path: '${{ steps.setup_poetry.outputs.repo-path }}'"
          if [ -n "${{ steps.setup_poetry.outputs.repo-path }}" ]; then
            test -d "${{ steps.setup_poetry.outputs.repo-path }}" && echo "repo-path points to a directory" || echo "repo-path is not a directory"
          else
            echo "python-poetry-setup did not resolve a repo-path"
          fi

      # Example: show how to call the check-version composite action. Disabled by default
      - name: "Example: call check-version (disabled)"
        if: false
        uses: ./.github/actions/check-version
        with:
          python-version: '3.11'
          poetry-version: '1.4.2'
          repository: darrylmorton/ct-continuous-workflows
          package-manager: poetry
          repo-path: ${{ steps.setup_poetry.outputs.repo-path }}
          action-path-required: 'true'
